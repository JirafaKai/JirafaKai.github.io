<!DOCTYPE HTML>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="zh-tw">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="author" content="JirafaKai">

	<link media="all" type="text/css" rel="stylesheet" href="main.css">
    <link media="all" type="text/css" rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link media="all" type="text/css" rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
    
    <!--[if lt IE 9]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<!--
Google spreadsheet = https://docs.google.com/spreadsheets/d/1osCn09v241irWHcW2t21XxVjv41sSRMdb5rCduNG24I/pubhtml
JSON = https://spreadsheets.google.com/feeds/list/1osCn09v241irWHcW2t21XxVjv41sSRMdb5rCduNG24I/od6/public/values?alt=json

https://docs.google.com/forms/d/1NJxcKOtlviztl54Em5esFJS3tejv-WGX2fYvH9azEqA/formResponse?entry.1562942030=123&entry.2001095882=683459&submit=Submit
-->

<body>
	<header id="banner" class="body">
	<!--navigation bar on the top><!-->
      <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
          <div class="navbar-header">
            <span class="navbar-brand">BRAND</span>
          </div>
      </div>    
      </nav>
	</header>
  
	<div class="container">
        <div id="search-box">
                <label for="inputKeyword" class="sr-only">關鍵字</label>
                <input type="text" id="inputKeyword" class="form-control" placeholder="請輸入關鍵字 ex. 紅蓮、弓手、杖" required autofocus>
        </div>
    </div>
	
    <div class="container">	
			<div id="result">
				
			</div>
	</div>

	<div id="overlay-loading">
		<div id="overlay-loading-content">
			<i class="fa fa-spinner fa-pulse fa-4x"></i>
            <div>從 google spreadsheets 讀取問題資料（<span id="loaded-count"></span>）</div>
        </div>
    </div>

	
	<script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
	<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../bootstrap/twitter-bootstrap-v2/docs/assets/js/jquery.js"></script>
    <script type="text/javascript" src="../bootstrap/twitter-bootstrap-v2/docs/assets/js/bootstrap-collapse.js"></script>
	
	<script>
	var exeOrder = 0;
	var sheetId = '1osCn09v241irWHcW2t21XxVjv41sSRMdb5rCduNG24I';
	var finishCount = 0;
	var gridIds = {
		'charactor' : ['charactor', 'loadChar']
		//'weapon'	: ['weapon', 'loadWeapon']
	};
	
	function getTime()
	{
		var Today = new Date();
		return Today.getFullYear() + ' / ' + parseInt(Today.getMonth()+1) + ' / ' + Today.getDate();
	}
	
    function charAttr (charno, imgSrc, cname, ccname, cnName, phase, star, type, hp, hhp, sp, hsp, atk, hatk, def, hdef, cri, hcri, spr, ls1, ls2, as1, as1sp, as2, as2sp, ds1, ds2, ds3, spcComm, gamewith) {
	  this.charno=charno;
      this.imgSrc=imgSrc;
      this.cName=cname;
      this.ccName=ccname;
      this.cnName=cnName;
      this.phase=phase;
      this.star=star;
      this.type=type;
      this.lvMaxAttr={hp:hp, sp:sp, atk:atk, def:def, cri:cri, spr:spr};
      this.hyperAttr={hp:hhp, sp:hsp, atk:hatk, def:hdef, cri:hcri};
      this.sprComm=spcComm;
      this.skill={ls:[ls1,ls2], as:[as1,as1sp,as2,as2sp], ds:[ds1,ds2,ds3]};
      this.gamewith=gamewith;
    }
	
	function commAttr (charNo, comment, iTime) {
		this.charNo=charNo;
		this.iTime=iTime;
		this.comment=comment;
	}
      
    var charactor=[];
	var commentG=[];

	$(document).ready(
		function() {
	
		var urlScript = "https://spreadsheets.google.com/feeds/list/1osCn09v241irWHcW2t21XxVjv41sSRMdb5rCduNG24I/2/public/values?alt=json";
		var urlScript2 = "https://spreadsheets.google.com/feeds/list/1osCn09v241irWHcW2t21XxVjv41sSRMdb5rCduNG24I/1/public/values?alt=json";
		
		$.getJSON(urlScript2, 
			function(JData){
				for (var i in JData.feed.entry){
                    commentG[i] = new commAttr(
						JData.feed.entry[i].gsx$charno.$t,
						JData.feed.entry[i].gsx$commentmsg.$t,
						JData.feed.entry[i].gsx$time.$t
					);
			}
		});
		
		
		$.getJSON(urlScript, 
			function(JData){
				for (var i in JData.feed.entry){
                    
                    charactor[i] = new charAttr(
					  JData.feed.entry[i].gsx$charno.$t,
                      JData.feed.entry[i].gsx$imgsrc.$t,
                      JData.feed.entry[i].gsx$charname.$t,
                      JData.feed.entry[i].gsx$ccharname.$t,
                      JData.feed.entry[i].gsx$charnickname.$t,
                      JData.feed.entry[i].gsx$phase.$t,
                      JData.feed.entry[i].gsx$charstar.$t,
                      JData.feed.entry[i].gsx$chartype.$t,
                      JData.feed.entry[i].gsx$maxhp.$t,
                      JData.feed.entry[i].gsx$hyperhp.$t,
                      JData.feed.entry[i].gsx$maxsp.$t,
                      JData.feed.entry[i].gsx$hypersp.$t,
                      JData.feed.entry[i].gsx$maxatk.$t,
                      JData.feed.entry[i].gsx$hyperatk.$t,
                      JData.feed.entry[i].gsx$maxdef.$t,
                      JData.feed.entry[i].gsx$hyperdef.$t,
                      JData.feed.entry[i].gsx$maxcri.$t,
                      JData.feed.entry[i].gsx$hypercri.$t,
                      JData.feed.entry[i].gsx$spr.$t,
                      JData.feed.entry[i].gsx$ls1.$t,
                      JData.feed.entry[i].gsx$ls2.$t,
                      JData.feed.entry[i].gsx$as1.$t,
					  JData.feed.entry[i].gsx$as1sp.$t,
                      JData.feed.entry[i].gsx$as2.$t,
					  JData.feed.entry[i].gsx$as2sp.$t,
                      JData.feed.entry[i].gsx$ds1.$t,
                      JData.feed.entry[i].gsx$ds2.$t,
                      JData.feed.entry[i].gsx$ds3.$t,
                      JData.feed.entry[i].gsx$sprcomm.$t,
                      JData.feed.entry[i].gsx$gamewith.$t
                    );
                    
			}
			$("#overlay-loading").remove();
		});
		
		//$('form').on 'submit', -> console.log 'submit'; false
		
		var key = document.getElementById("inputKeyword");
		
		
		key.onkeyup = function(e){
		var urlScript2 = "https://spreadsheets.google.com/feeds/list/1osCn09v241irWHcW2t21XxVjv41sSRMdb5rCduNG24I/1/public/values?alt=json";
		$.getJSON(urlScript2, 
			function(JData){
				for (var q in JData.feed.entry){
                    commentG[q] = new commAttr(
						JData.feed.entry[q].gsx$charno.$t,
						JData.feed.entry[q].gsx$commentmsg.$t,
                        JData.feed.entry[q].gsx$time.$t
					);
			}
		});
			$("#result").html("");
			
			for (var i in charactor){
			
				if (key.value.length <= 0) {
					return $("#result").html("");
				}
				
				var keyword = key.value.trim().split(" ");
				var checknum = 0;
				var checknum2 = 0;
				for(var n in keyword){
					if(keyword[n] !== ""){checknum2++;	// prevent 2 spaces together, cannot use keyword.length (num of element of keyword array)
					if(charactor[i].cName.indexOf(keyword[n]) !== -1) checknum++;    // !==-1 -> is match
                    if(charactor[i].cnName.indexOf(keyword[n]) !== -1) checknum++;
					if(charactor[i].type.indexOf(keyword[n]) !== -1) checknum++;
					if(charactor[i].star.indexOf(keyword[n]) !== -1) checknum++;}
				}
				if((checknum >= checknum2) && key.value.trim().length !== 0)
				{
					var color = typecolor(charactor[i].type);
					$("#result").append('<table class="table" id="charTable"><tr>'
										+ '<td id="imgtd"><img style="width:70px;" src="' + charactor[i].imgSrc + '"></img></td>'                //image
										+ '<td style="width:450px;" id="charNametd"><span class="tag-label" style="background:' + color + ';">' + charactor[i].phase + '</span>'    //phase
                                        + '<span class="tag-label" style="background:' + color + ';">' + charactor[i].star + '</span>'                         //star
                                        + '<span class="tag-label" style="background:' + color + ';">' + charactor[i].type +'</span>'                          //type
                                        + '<br/>' + charactor[i].cName                                              //chinese name
                                        + '<br/>' + charactor[i].cnName + '</td>'
                                        + '<td id="attrtd"><table id="innerCharTable"><tr><td id="attrInnertd" style="background:' + color + ';">LV.100</td>'  //table of LV100 attribute
                                        + '<td class="attrInnertd">HP '+ charactor[i].lvMaxAttr.hp + '</td>'
                                        + '<td class="attrInnertd">SP '+ charactor[i].lvMaxAttr.sp + '</td>'
                                        + '<td class="attrInnertd">ATK '+ charactor[i].lvMaxAttr.atk + '</td>'
                                        + '<td class="attrInnertd">DEF '+ charactor[i].lvMaxAttr.def + '</td>'
                                        + '<td class="attrInnertd">CRI '+ charactor[i].lvMaxAttr.cri + '</td>'
                                        + '<td class="attrInnertd">SPR '+ charactor[i].lvMaxAttr.spr + '</td></tr></table>'
                                        + '<table id="innerCharTable"><tr>'
                                        + '<td id="attrInnertd" style="background:#fff; color:#000;width:400px;text-align:left;padding-left:15px;">SPR上限：' + charactor[i].sprComm + '</td>'
                                        + '<td class="attrInnertd" style="width:150px;border:2px solid '+color+';color:'+color+';">Gamewith評價：' + charactor[i].gamewith + '</td>'
                                        + '</tr></table></td>'
                                        + '<td id="more"><a href="#char' + i + ' "data-toggle="collapse">更多</a><br/>'      //more button
                                        + '<a href="#comm' + charactor[i].charno + ' "data-toggle="collapse">評價</a></td>'				//comment button
										+ '</tr>');
                    $("#result").append('<div id="char' + i + '" class="collapse">'
                                        + '<table class="table" id="skillTable"><tr>'
										+ '<tr><td id="titletd">隊長技能1</td><td>' + charactor[i].skill.ls[0] + '</td></tr>'
										+ '<tr><td id="titletd">隊長技能2</td><td>' + charactor[i].skill.ls[1] + '</td></tr>'
                                        + '<tr><td id="titletd">主動技能1</td><td>' + charactor[i].skill.as[0] + '<br/>消費SP：' + charactor[i].skill.as[1] + '</td></tr>'
                                        + '<tr><td id="titletd">主動技能2</td><td>' + charactor[i].skill.as[2] + '<br/>消費SP：' + charactor[i].skill.as[3] + '</td></tr>'
                                        + '<tr><td id="titletd">被動技能</td><td>' + charactor[i].skill.ds[0] + '<br/>'
                                        + charactor[i].skill.ds[1] + '<br/>'
                                        + charactor[i].skill.ds[2] 
                                        + '</td></tr></table></div>');
					var comment = '<div id="comm' + charactor[i].charno + '" class="collapse">' + makecomment(i,"") + '</div>';
					$("#result").append(comment);
				}
			}	
		};
		
	});
	function sumitcom (i) {
		var nid = 'inputCommt' + charactor[i].charno;
		var result = 'https://docs.google.com/forms/d/1NJxcKOtlviztl54Em5esFJS3tejv-WGX2fYvH9azEqA/formResponse?'
					+ 'entry.1562942030=' + charactor[i].charno
					+ '&entry.2001095882=' + document.getElementById(nid).value
					+ '&entry.714632310=' + getTime()
					+ '&submit=Submit';			
		$.getScript(result);
		var commt = document.getElementById(nid).value;
		document.getElementById(nid).value = "";
		commentG=[];
		var urlScript2 = "https://spreadsheets.google.com/feeds/list/1osCn09v241irWHcW2t21XxVjv41sSRMdb5rCduNG24I/1/public/values?alt=json";
		$.getJSON(urlScript2, 
			function(JData){
				for (var q in JData.feed.entry){
                    commentG[q] = new commAttr(
						JData.feed.entry[q].gsx$charno.$t,
						JData.feed.entry[q].gsx$commentmsg.$t,
                        JData.feed.entry[q].gsx$time.$t
					);
				nid = 'comm' + charactor[i].charno;
				document.getElementById(nid).innerHTML = makecomment(i,commt);
			}
		});
	}
	function makecomment(i,comment){
				var content = '<table class="table table-striped" id="commTable">'
							+ '<tr><td colspan="2"><input class="inputComm" type="text" id="inputCommt' + charactor[i].charno+ '" placeholder="可輸入評語" />'
							+ '<input type="button" value="提交" onclick="sumitcom(' + i + ')"</td></tr>';
				if(comment != ""){
							+ '<tr><td class="commTime" id="commtd"><span class="spanTime">' + getTime() + '</span></td><td class="commTd">' + comment + '</td></tr>';}
				for(var c in commentG){
					if(commentG[c].charNo == charactor[i].charno)
					content += '<tr><td class="commTime" id="commtd"><span class="spanTime">' + commentG[c].iTime + '</span></td><td class="commTd">' + commentG[c].comment + '</td></tr>';
				}
				content += '</table>';
				return content;
	}
	function typecolor(type){
		var color="#";
		if(type == "劍")color += "e03d3e;";
		else if(type == "法")color += "c056dc";
		else if(type == "槍")color += "20dc3f";
		else if(type == "斧")color += "1c7cd0";
		else if(type == "弓")color += "fc6d21";
		else if(type == "拳")color += "d8c238";
		else if(type == "雙劍")color += "e4688c";
		return color;
	}
	</script>


</body>
</html>
